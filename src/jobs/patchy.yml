description: |
  Automated patching.

  The following Make targets are required and will be called:
   - init-backend
   - mkdirs

parameters:
  executor:
    type: executor
    description: The executor to use.
  ssh_fingerprint:
    description: The SSH fingerprint used for writing back to the project repo.
    type: string

executor: <<parameters.executor>>

steps:
  - add_ssh_keys:
      fingerprints:
        - <<parameters.ssh_fingerprint>>
  - checkout
  - restore_cache:
      keys:
        - deps-composer-{{ arch }}-{{ checksum "composer.lock" }}
        - deps-composer-{{ arch }}-
  - run:
      name: Init
      command: make init-backend mkdirs
  - run:
      name: Patchy
      command: <<include(scripts/patchy.sh)>>

description: >
  Build the Drupal backend.

parameters:
  tag:
    default: 7.4-1.x
    description: The Skpr PHP image version tag
    type: string
  init:
    type: steps
    description: Initialise the backend dependencies.
    default:
      - run:
          name: Init
          command: make init-backend
  lint:
    type: steps
    description: Check the codebase against style guidelines.
    default:
      - run:
          name: Lint
          command: make lint-backend
      - run:
          name: Security check
          command: make security-check
  unit-test:
    type: steps
    description: Run the the backend-end tests.
    default: []

executor:
  name: php
  tag: <<parameters.tag>>

steps:
  - checkout
  - restore_cache:
      keys:
        - deps-php-{{ arch }}-{{ checksum "composer.lock" }}
        - deps-php-{{ arch }}-
  - steps: <<parameters.init>>
  - save_cache:
      key: deps-composer-{{ arch }}-{{ checksum "composer.lock" }}
      paths:
        - app/core
        - app/modules/contrib
        - app/themes/contrib
        - vendor
  - steps: <<parameters.lint>>
  - steps: <<parameters.unit-test>>
  - persist_to_workspace:
      root: /data
      paths:
        - bin
        - app/core
        - app/modules/contrib
        - app/profiles/contrib
        - app/themes/contrib
        - drush/Commands/contrib
        - vendor
